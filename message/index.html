<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Messases - Tanvir E-mart</title>
    <!-- Global styles for bottom nav -->
    <link rel="stylesheet" href="../style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Ensure the chat area stays above the fixed bottom navbar */
        .page-wrapper {
            min-height: 100vh;
            padding-bottom: var(--bottom-nav-height, 70px);
        }

        .chat-container {
            background: white;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: 100%;
            height: calc(100vh - var(--bottom-nav-height, 70px));
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* When coming from product page, hide bottom nav and adjust height */
        .chat-container.from-product {
            height: 100vh;
        }

        .chat-container.from-product ~ .bottom-nav {
            display: none;
        }

        .chat-header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-header.from-product .back-button {
            display: block;
        }

        .name-input-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .name-input-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .name-input-section input:focus {
            border-color: #4CAF50;
        }

        .name-input-section button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .name-input-section button:hover {
            background: #45a049;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.public {
            align-items: flex-end;
        }

        .message.admin {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
        }

        .message.public .message-bubble {
            background: #4CAF50;
            color: white;
        }

        .message.admin .message-bubble {
            background: #e9ecef;
            color: #333;
        }

        .message-info {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }

        .message-input-section {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: none;
        }

        .message-input-container {
            display: flex;
            gap: 10px;
        }

        .message-input-container input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .message-input-container input:focus {
            border-color: #4CAF50;
        }

        .message-input-container button {
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .message-input-container button:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        @media (max-width: 480px) {
            .chat-container { height: calc(100vh - var(--bottom-nav-height, 70px)); }
        }

        .hidden {
            display: none !important;
        }

        /* Product Info Section Styles - Fixed at bottom */
        .product-info-section {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .product-info-card {
            display: flex;
            gap: 15px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .product-info-image {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .product-info-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info-details {
            flex: 1;
            min-width: 0;
        }

        .product-info-details h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            line-height: 1.3;
        }

        .product-info-price {
            margin: 0 0 5px 0;
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }

        .product-info-description {
            margin: 0;
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Message Product Info Styles for Public Chat */
        .message-product-info {
            margin: 8px 0;
        }

        .message-product-info .product-info-card {
            display: flex;
            gap: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #e9ecef;
            max-width: 300px;
        }

        .message-product-info .product-info-image {
            flex-shrink: 0;
        }

        .message-product-info .product-info-details {
            flex: 1;
            min-width: 0;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="chat-container" id="chatContainer">
            <div class="chat-header" id="chatHeader">
                <button class="back-button" id="backButton" onclick="goBack()">‚Üê Back</button>
                <div>üí¨ Tanvir E-mart</div>
            </div>
            
            <div class="name-input-section" id="nameSection">
                <input type="text" id="nameInput" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." maxlength="50">
                <input type="tel" id="phoneInput" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ (optional)" inputmode="tel" maxlength="20" style="margin-top:10px;">
                <button onclick="startChat()">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="loading">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...</div>
            </div>

            <!-- Product Info Section (hidden by default) - Below chat messages -->
            <div class="product-info-section" id="productInfoSection" style="display: none;">
                <div class="product-info-card">
                    <div class="product-info-image">
                        <img id="productInfoImage" src="" alt="Product">
                    </div>
                    <div class="product-info-details">
                        <h4 id="productInfoName"></h4>
                        <p class="product-info-price" id="productInfoPrice"></p>
                    </div>
                </div>
            </div>

            <div class="message-input-section" id="messageSection">
                <div class="message-input-container">
                    <input type="text" id="messageInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." maxlength="500">
                    <button onclick="sendMessage()">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keep the existing bottom navigation bar unchanged -->
    <nav class="bottom-nav" id="bottom-nav">
        <a href="../index.html#banner" class="bottom-nav-link" id="nav-home"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="../index.html#categories" class="bottom-nav-link" id="nav-category"><i class="fas fa-th-large"></i><span>Category</span></a>
        <a href="../cart/index.html" class="bottom-nav-link" id="nav-cart"><i class="fas fa-shopping-cart"></i><span>Cart</span></a>
        <a href="./" class="bottom-nav-link active" id="nav-message"><i class="fas fa-comments"></i><span>Message</span></a>
        <a href="../account/" class="bottom-nav-link" id="nav-account"><i class="fas fa-user"></i><span>Account</span></a>
    </nav>

    <script type="module">
        // Import Firebase modules for the Messages project (Sadiya Mart)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        // Also import MAIN public app auth+db so we can reuse the logged-in identity (tanviremart)
        import { auth as mainAuth, db as mainDb } from "../firebase-config.js";

        // Firebase configuration for Sadiya Mart chat
        const firebaseConfig = {
            apiKey: "AIzaSyBESpHOxFBZIZhlehhdIAHVGGVpQ7lEBsU",
            authDomain: "sadiya-mart.firebaseapp.com",
            projectId: "sadiya-mart",
            storageBucket: "sadiya-mart.firebasestorage.app",
            messagingSenderId: "681962945365",
            appId: "1:681962945365:web:3eec64312ee0b2a4af8ddc",
            measurementId: "G-8V9446FKPP"
        };

        // Initialize Firebase (Messages project only)
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userName = '';
        let unsubscribeMessages = null;
        let currentUid = null;
        const PROFILE_KEY = 'sadiyaChatProfile';
        let savedProfile = null;
        let autoStarted = false;
        let currentProductInfo = null; // Add product info variable
        let mainUser = null; // currently logged-in user from MAIN public app
        let unsubscribeMainProfile = null;

        // Check for product info from localStorage
        function loadProductInfo() {
            try {
                const productInfo = localStorage.getItem('chatProductInfo');
                if (productInfo) {
                    currentProductInfo = JSON.parse(productInfo);
                    localStorage.removeItem('chatProductInfo'); // Clear after loading
                    showProductInfo();
                    
                    // If we have product info, we came from product page
                    setupProductPageMode();
                }
            } catch (error) {
                console.error('Error loading product info:', error);
            }
        }

        // Setup product page mode (hide bottom nav, show back button)
        function setupProductPageMode() {
            const chatContainer = document.getElementById('chatContainer');
            const chatHeader = document.getElementById('chatHeader');
            const bottomNav = document.getElementById('bottom-nav');
            
            if (chatContainer) chatContainer.classList.add('from-product');
            if (chatHeader) chatHeader.classList.add('from-product');
            if (bottomNav) bottomNav.style.display = 'none';
        }

        // Go back function
        window.goBack = function() {
            // Go back to previous page
            window.history.back();
        };

        // Show product info section
        function showProductInfo() {
            if (!currentProductInfo) return;
            
            const productSection = document.getElementById('productInfoSection');
            const productImage = document.getElementById('productInfoImage');
            const productName = document.getElementById('productInfoName');
            const productPrice = document.getElementById('productInfoPrice');
            
            if (productImage) productImage.src = currentProductInfo.image || 'https://via.placeholder.com/60x60?text=No+Image';
            if (productName) productName.textContent = currentProductInfo.name || 'Product';
            if (productPrice) productPrice.textContent = `‡ß≥${currentProductInfo.price || '0'}`;
            
            productSection.style.display = 'block';
        }

        // Ensure anonymous auth for the messages project
        signInAnonymously(auth).catch(() => {});
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUid = user.uid;
                initOrResumeChat();
                watchMainUserProfile();
            } else {
                currentUid = null;
                watchMainUserProfile();
            }
        });

        // Track MAIN public app login state to reuse identity if available
        onAuthStateChanged(mainAuth, (user) => {
            mainUser = user || null;
            // If messages auth already ready, try to init with main identity
            if (auth.currentUser) {
                initOrResumeChat();
            }
            watchMainUserProfile();
        });

        // Load product info on page load
        loadProfileFromStorage();
        loadProductInfo();
        
        // Also load product info when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadProductInfo();
        });

        function loadProfileFromStorage() {
            try {
                const raw = localStorage.getItem(PROFILE_KEY);
                savedProfile = raw ? JSON.parse(raw) : null;
            } catch (_) {
                savedProfile = null;
            }
        }

        function saveProfileToStorage(profile) {
            try { localStorage.setItem(PROFILE_KEY, JSON.stringify(profile)); } catch (_) {}
        }

        async function ensureConversationDoc(profile) {
            const convRef = doc(db, 'conversations', currentUid);
            // Build identity snapshot
            const identity = await buildIdentitySnapshot(profile);
            await setDoc(convRef, {
                userName: identity.userName,
                phone: identity.phone,
                mainUid: identity.mainUid || '',
                mainEmail: identity.mainEmail || '',
                mainDisplayName: identity.mainDisplayName || '',
                mainPhone: identity.mainPhone || '',
                guestName: identity.guestName || '',
                guestPhone: identity.guestPhone || '',
                guest: identity.guest === true,
                createdAt: serverTimestamp(),
                status: 'open'
            }, { merge: true });
        }

        function watchMainUserProfile() {
            if (!mainUser || !currentUid) {
                if (unsubscribeMainProfile) { try { unsubscribeMainProfile(); } catch (_) {} }
                unsubscribeMainProfile = null;
                return;
            }
            // Already listening
            if (unsubscribeMainProfile) return;
            const userDocRef = doc(mainDb, 'users', mainUser.uid);
            unsubscribeMainProfile = onSnapshot(userDocRef, async (snap) => {
                try {
                    if (!snap.exists()) return;
                    const data = snap.data();
                    const phone = (data && data.phone) ? String(data.phone) : '';
                    if (!phone) return;
                    // Upsert conversation with latest main phone
                    await setDoc(doc(db, 'conversations', currentUid), { phone: phone, mainPhone: phone }, { merge: true });
                } catch (e) {
                    // ignore
                }
            });
        }

        async function buildIdentitySnapshot(profile) {
            if (mainUser) {
                const display = mainUser.displayName || mainUser.email || profile?.name || 'User';
                // Strictly prefer main account phone (from users profile), otherwise auth phone.
                let dbPhone = '';
                try {
                    const snap = await getDoc(doc(mainDb, 'users', mainUser.uid));
                    const data = snap.exists() ? snap.data() : null;
                    if (data && data.phone) dbPhone = String(data.phone);
                } catch (_) {}
                const phone = dbPhone || (mainUser.phoneNumber ? String(mainUser.phoneNumber) : '');

                return {
                    userName: display,
                    phone,
                    mainUid: mainUser.uid,
                    mainEmail: mainUser.email || '',
                    mainDisplayName: mainUser.displayName || '',
                    mainPhone: phone,
                    guestName: '',
                    guestPhone: '',
                    guest: false
                };
            }
            // Guest identity from prompt profile
            return {
                userName: profile?.name || 'Guest',
                phone: profile?.phone || '',
                guestName: profile?.name || 'Guest',
                guestPhone: profile?.phone || '',
                guest: true
            };
        }

        async function initOrResumeChat() {
            if (!currentUid) return;
            // Proceed if either main user is logged in OR we have a saved guest profile
            if (!mainUser && !savedProfile) return;
            if (autoStarted) return;

            // Resolve identity
            const profile = mainUser ? { name: mainUser.displayName || mainUser.email || 'User', phone: mainUser.phoneNumber || '' } : savedProfile;
            userName = profile.name;
            await ensureConversationDoc(profile);
            // Hide name prompt if using main identity
            if (mainUser) {
                document.getElementById('nameSection').classList.add('hidden');
            }
            document.getElementById('messageSection').style.display = 'block';
            loadMessages();
            autoStarted = true;
        }

        // Global functions
        window.startChat = async function() {
            const nameInput = document.getElementById('nameInput');
            const phoneInput = document.getElementById('phoneInput');
            userName = nameInput.value.trim();
            const phone = (phoneInput.value || '').trim();
            
            if (!userName) {
                alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
                return;
            }

            if (!auth.currentUser) {
                await signInAnonymously(auth);
            }
            currentUid = auth.currentUser.uid;

            // Save profile locally and create/update conversation doc
            const profile = { name: userName, phone };
            saveProfileToStorage(profile);
            savedProfile = profile;
            await ensureConversationDoc(profile);

            document.getElementById('nameSection').classList.add('hidden');
            document.getElementById('messageSection').style.display = 'block';
            
            // Load product info if available
            loadProductInfo();
            
            loadMessages();
        };

        window.sendMessage = async function() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentUid) {
                return;
            }

            try {
            // Build identity for this message
            const identity = await buildIdentitySnapshot(savedProfile || { name: userName, phone: '' });
            const messageData = {
                    name: userName,
                    message: message,
                    timestamp: serverTimestamp(),
                    sender: 'public',
                    mainUid: identity.mainUid || '',
                    guest: identity.guest === true
                };

                // Add product info if available
                if (currentProductInfo) {
                    messageData.productInfo = {
                        id: currentProductInfo.id,
                        name: currentProductInfo.name,
                        price: currentProductInfo.price,
                        image: currentProductInfo.image
                    };
                }

                await addDoc(collection(db, 'conversations', currentUid, 'messages'), messageData);

                await updateDoc(doc(db, 'conversations', currentUid), {
                    lastMessage: message,
                    lastMessageAt: serverTimestamp(),
                    lastSender: 'public',
                    userName: identity.userName,
                    phone: identity.phone,
                    mainUid: identity.mainUid || '',
                    mainEmail: identity.mainEmail || '',
                    mainDisplayName: identity.mainDisplayName || '',
                    mainPhone: identity.mainPhone || '',
                    guestName: identity.guestName || '',
                    guestPhone: identity.guestPhone || '',
                    guest: identity.guest === true,
                    // Add product info to conversation if this is the first message with product
                    ...(currentProductInfo && { productInfo: currentProductInfo })
                });

                messageInput.value = '';
                
                // Clear product info after first message to avoid attaching to every message
                if (currentProductInfo) {
                    currentProductInfo = null;
                    const productSection = document.getElementById('productInfoSection');
                    if (productSection) {
                        productSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        };

        // Handle Enter key press
        document.addEventListener('DOMContentLoaded', function() {
            loadProfileFromStorage();
            if (savedProfile) {
                // Hide prompt immediately; will auto-start when auth is ready
                document.getElementById('nameSection').classList.add('hidden');
                document.getElementById('messageSection').style.display = 'block';
                // Pre-fill (in case user opens the form later)
                const nameInput = document.getElementById('nameInput');
                const phoneInput = document.getElementById('phoneInput');
                if (nameInput) nameInput.value = savedProfile.name || '';
                if (phoneInput) phoneInput.value = savedProfile.phone || '';
            }
            document.getElementById('nameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startChat();
                }
            });

            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });

        function loadMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '<div class="loading">‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>';

            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            const q = query(collection(db, 'conversations', currentUid, 'messages'), orderBy('timestamp', 'asc'));
            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                chatMessages.innerHTML = '';
                
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    displayMessage(data);
                });

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        function displayMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.sender}`;

            const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('bn-BD', {
                hour: '2-digit',
                minute: '2-digit'
            }) : '‡¶è‡¶ñ‡¶®';

            let productInfoHtml = '';
            if (data.productInfo) {
                productInfoHtml = `
                    <div class="message-product-info">
                        <div class="product-info-card">
                            <div class="product-info-image">
                                <img src="${data.productInfo.image || 'https://via.placeholder.com/60x60?text=No+Image'}" alt="${data.productInfo.name}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;">
                            </div>
                            <div class="product-info-details">
                                <div style="font-weight:600;font-size:16px;color:#333;margin-bottom:4px;">${data.productInfo.name}</div>
                                <div style="font-weight:bold;color:#4CAF50;font-size:18px;margin-bottom:4px;">‡ß≥${data.productInfo.price}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="message-info">${data.name} ‚Ä¢ ${timestamp}</div>
                ${productInfoHtml}
                <div class="message-bubble">${data.message}</div>
            `;

            chatMessages.appendChild(messageDiv);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
        });
    </script>
</body>
</html>